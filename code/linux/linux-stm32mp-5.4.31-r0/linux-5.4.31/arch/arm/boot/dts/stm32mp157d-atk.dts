// SPDX-License-Identifier: (GPL-2.0+ OR BSD-3-Clause)
/*
 * Copyright (C) STMicroelectronics 2019 - All Rights Reserved
 * Author: Alexandre Torgue <alexandre.torgue@st.com> for STMicroelectronics.
 */
/dts-v1/;

#include "stm32mp157.dtsi"
#include "stm32mp15xc.dtsi"
#include "stm32mp15-pinctrl.dtsi"
#include "stm32mp15xxaa-pinctrl.dtsi"
#include "stm32mp157-m4-srm.dtsi"
#include "stm32mp157-m4-srm-pinctrl.dtsi"
#include "stm32mp157d-atk.dtsi"
// #include dt-bindings/usb/pd.h


/ {
	model = "STMicroelectronics STM32MP157C eval daughter";
	compatible = "st,stm32mp157c-ed1", "st,stm32mp157";

	chosen {
		stdout-path = "serial0:115200n8";
	};

	aliases {
		serial0 = &uart4;
		serial1 = &uart5;
		serial2 = &usart3;
	};

	reserved-memory {
		gpu_reserved: gpu@f6000000 {
			reg = <0xf6000000 0x8000000>;
			no-map;
		};

		optee_memory: optee@fe000000 {
			reg = <0xfe000000 0x02000000>;
			no-map;
		};
	};
	leds {
		compatible = "mp157led";
		pinctrl-0 = <&led_pins_a>;
		status = "okay";
		led0 {
			label = "red";
			gpios = <&gpioi 0 GPIO_ACTIVE_LOW>;
			default-state = "on";
		};
		led1 {
			label = "green";
			gpios = <&gpiof 3 GPIO_ACTIVE_LOW>;
			default-state = "on";
		};
	};
	beep {
		compatible = "mp157d-beep";
		pinctrl-names = "default";
		label = "mp157beep";
		pinctrl-0 = <&beep_pins_a>;
		beep-gpio = <&gpioc 7 GPIO_ACTIVE_HIGH>;
		default-state = "off";
		status = "disabled";
	};
	key {
		compatible = "mp157d-key";
		pinctrl-0 = <&key_pins_a>;
		status = "okay";
		KEY0 {
			label = "key0";
			pinctrl-names = "default";
			gpios = <&gpiog 3 GPIO_ACTIVE_HIGH>;
			interrupt-parent = <&gpiog>;
			interrupts = <3 IRQ_TYPE_EDGE_BOTH>;
			default-state = "off";
		};
		KEY1 {
			label = "key1";
			pinctrl-names = "default";
			gpios = <&gpioh 7 GPIO_ACTIVE_HIGH>;
			interrupt-parent = <&gpioh>;
			interrupts = <7 IRQ_TYPE_EDGE_BOTH>;
			default-state = "off";
		};
	};
	panel_rgb: panel-rgb {
		compatible = "alientek,lcd-rgb";
		backlight = <&backlight>;
		status = "okay";
		port {
			rgb_panel_in: endpoint {
				remote-endpoint = <&ltdc_ep0_out>;
			};
		};
	};
	backlight: backlight {
		compatible = "pwm-backlight";
		pwms = <&pwm4 1 5000000>;
		brightness-levels = <0 4 8 16 32 64 128 255>;
		power-supply = <&v3v3>;
		default-brightness-level = <7>;
		status = "okay";
	};	
	v1v8_audio: regulator-v1v8-audio {
		compatible = "regulator-fixed";
		regulator-name = "v1v8_audio";
		regulator-min-microvolt = <1800000>;
		regulator-max-microvolt = <1800000>;
		regulator-always-on;
		regulator-boot-on;
	};
	// sound {
	// 	compatible = "audio-graph-card";
	// 	label = "STM32MP1-DK";
	// 	routing =
	// 		"Playback" , "MCLK",
	// 		"Capture" , "MCLK",
	// 		"MICL" , "Mic Bias";
	// 	dais = <&sai2a_port &sai2b_port>;
	// 	status = "okay";
	// };
	usb_phy_tuning: usb-phy-tuning {
		st,hs-dc-level = <2>;
		st,fs-rftime-tuning;
		st,hs-rftime-reduction;
		st,hs-current-trim = <15>;
		st,hs-impedance-trim = <1>;
		st,squelch-level = <3>;
		st,hs-rx-offset = <2>;
		st,no-lsfs-sc;
	};

	vdd_usb: regulator-vdd-usb {
		compatible = "regulator-fixed";
		regulator-name = "vdd_usb";
		regulator-min-microvolt = <3300000>;
		regulator-max-microvolt = <3300000>;
		regulator-always-on;
		regulator-boot-on;
	};
	vin: regulator-vin {
		compatible = "regulator -fixed";
		regulator-name = "vin";
		regulator-min-microvolt = <5000000>;
		regulator-max-microvolt = <5000000>;
		regulator-always-on;
		regulator-boot-on;
	};
	fusb302@22 {
		compatible = "fcs,fusb302","fairchild,fusb302";
		reg = <0x22>;
		// interrupts = <2 IRQ_TYPE_EDGE_FALLING>;
		// interrupt-parent = <&gpiog>;
		pinctrl-names = "default";
		pinctrl-0 = <&fusb302_pins_a>;
		int-n-gpios = <&gpiog 2 GPIO_ACTIVE_HIGH>;
		vbus-5v-gpios = <&gpioz 6 GPIO_ACTIVE_HIGH>;
		status="okay";
		// vdd-supply = <&vin>;

		connector {
			compatible = "usb-c-connector";
			label = "USB-C";
			power-role = "dual";
			power-opmode = "default";

			try-power-role = "sink";
			source-pdos = <PDO_FIXED(5000 , 3000 , PDO_FIXED_USB_COMM)>;
			sink-pdos = <PDO_FIXED (5000 , 3000 , PDO_FIXED_USB_COMM )
						PDO_VAR(3000, 12000, 3000)
						PDO_PPS_APDO(3000, 11000 , 3000 )>;
			port {
				con_usbotg_hs_ep: endpoint {
					remote-endpoint = <&usbotg_hs_ep>;
				};
			};
		};
	};
	ds18b20 {
		compatible = "zave,ds18b20";
		ds18b20-gpio = <&gpiof 2 GPIO_ACTIVE_LOW>;
		status = "okay";
		};
};

&cpu1{
	cpu-supply = <&vddcore>;
};

&cryp1 {
	status="okay";
};

&gpu {
	contiguous-area = <&gpu_reserved>;
	status = "okay";
};

&optee {
	status = "okay";
};

&timers1 {
	status = "disabled";
	/delete-property/dmas;
	/delete-property/dma-names;
		pwm1: pwm {
			pinctrl-0 = <&pwm3_pins_a>;
			pinctrl-1 = <&pwm3_sleep_pins_a>;
			pinctrl-names = "default", "sleep";
			#pwm-cells = <2>;
			status = "disabled";
	};
};

&ltdc {
	pinctrl-names = "default", "sleep";
	pinctrl-0 = <&ltdc_pins_b>;
	pinctrl-1 = <&ltdc_pins_sleep_b>;
	status = "okay";
	port {
		#address-cells = <1>;
		#size-cells = <0>;
		ltdc_ep0_out: endpoint@0 {
			reg = <0>;
			remote-endpoint = <&rgb_panel_in>;
		};
	};
};

&timers4 {
	status = "okay";
	/* spare dmas for other usage */
	/delete-property/dmas;
	/delete-property/dma-names;
	pwm4: pwm {
		pinctrl-0 = <&pwm4_pins_b>;
		pinctrl-1 = <&pwm4_sleep_pins_b>;
		pinctrl-names = "default", "sleep";
		#pwm-cells = <2>;
		status = "okay";
	};
};		

&i2c5 {
	pinctrl-names = "default", "sleep";
	pinctrl-0 = <&i2c5_pins_a>;
	pinctrl-1 = <&i2c5_pins_sleep_a>;
	status = "okay";

	at24c08@50 {
		compatible = "zave,at24c08";
		reg = <0x50>;
	};
};

// &spi1 {
// 	pinctrl-names = "default" , "sleep" ;
// 	pinctrl-0 = <&spi1_pins_a>;
// 	pinctrl-1 = <&spi1_sleep_pins_a>;
// 	cs-gpios = <gpioz 3 GPIO_ACTIVE_LOW>;
// 	status = "disabled";

// 	spidev: bmp180@0 {
// 		compatible = "alientek,bmp180";
// 		reg = <0>; /* CS #0 */
// 		spi-max-frequency = <8000000>;
// 	};
// };

&spi1 {
	pinctrl-names = "default" , "sleep" ;
	pinctrl-0 = <&spi1_pins_a>;
	pinctrl-1 = <&spi1_sleep_pins_a>;
	cs-gpios = <&gpioz 3 GPIO_ACTIVE_LOW>;
	status = "okay";

	spidev: w25q64@0 {
		compatible = "winbond,w25q64";
		reg = <0>; /* CS #0 */
		spi-max-frequency = <8000000>;
	};
};

&usart3 {
	pinctrl-names = "default";
	pinctrl-0 = <&usart3_pins_c>;
	status = "okay";
};

&uart5 {
	pinctrl-names = "default";
	pinctrl-0 = <&uart5_pins_a>;
	status = "okay";
};	

// 直接使用Linux内核自带驱动
&i2c2 {
	pinctrl-names = "default" , "sleep" ;
	pinctrl-0 = <&i2c2_pins_a>;
	pinctrl-1 = <&i2c2_pins_sleep_a>;
	status = "okay";
		ft5426: ft5426@38 {
			compatible = "goodix,gt9147";
			pinctrl-0 = <&ft5426int_reset_pins_a>;
			reg = <0x14>;
			interrupt-parent = <&gpioi>;
			interrupts = <1 IRQ_TYPE_EDGE_RISING>;
			interrupt-gpios = <&gpioi 1 GPIO_ACTIVE_LOW>;
			reset-gpios = <&gpioh 15 GPIO_ACTIVE_LOW>;
			status = "okay";
		};
};


&i2c4 {
	pinctrl-names = "default","sleep" ;
	pinctrl-0 = <&i2c4_pins_a>;
	pinctrl-1 = <&i2c4_pins_sleep_a>;
	status = "okay";
	
	pcf8563@51{
		compatible = "nxp,pcf8563";
		irq_gpio = <&gpioi 3 IRQ_TYPE_EDGE_FALLING>;
		reg = <0x51>;
	};
};

// &i2c4 {
// 	pinctrl-names = "default","sleep" ;
// 	pinctrl-0 = <&i2c4_pins_a>;
// 	pinctrl-1 = <&i2c4_pins_sleep_a>;
// 	status = "okay";
// 	/delete-property/dmas;
// 	/delete-property/dma-names;

// 	cs42l51: cs42l51@4a {
// 		compatible = "cirrus,cs42l51";
// 		reg = <0x4a>;
// 		#sound-dai-cells = <0>;
// 		VL-supply = <&v3v3>;
// 		VD-supply = <&v1v8_audio>;
// 		VA-supply = <&v1v8_audio>;
// 		VAHP-supply = <&v1v8_audio>;
// 		reset-gpios = <&gpioz 7 GPIO_ACTIVE_LOW>;
// 		clocks = <&sai2a>;
// 		clock-names = "MCLK";
// 		status = "okay";

// 		cs42l51_port: port {
// 			#address-cells = <1>;
// 			#size-cells = <0>;

// 			cs42l51_tx_endpoint: endpoint@0 {
// 				reg = <0>;
// 				remote-endpoint = <&sai2a_endpoint>;
// 				frame-master;
// 				bitclock-master;
// 			};

// 			cs42l51_rx_endpoint: endpoint@1 {
// 				reg = <1>;
// 				remote-endpoint = <&sai2b_endpoint>;
// 				frame-master;
// 				bitclock-master;
// 			};
// 		};
// 	};
// };

// &sai2 {
// 	clocks = <&rcc SAI2>, <&rcc PLL3_Q>, <&rcc PLL3_R>;
// 	clock-names = "pclk", "x8k", "x11k";
// 	pinctrl-names = "default", "sleep";
// 	pinctrl-0 = <&sai2a_pins_a>, <&sai2b_pins_b>;
// 	pinctrl-1 = <&sai2a_sleep_pins_a>, <&sai2b_sleep_pins_b>;
// 	status = "disable";

// 	sai2a: audio-controller@4400b004 {
// 		#clock-cells = <0>;
// 		dma-names = "tx";
// 		clocks = <&rcc SAI2_K>;
// 		clock-names = "sai_ck";
// 		status = "okay";

// 		sai2a_port: port {
// 			sai2a_endpoint: endpoint {
// 				remote-endpoint = <&cs42l51_tx_endpoint>;
// 				format = "i2s";
// 				mclk-fs = <256>;
// 				dai-tdm-slot-num = <2>;
// 				dai-tdm-slot-width = <32>;
// 			};
// 		};
// 	};

// 	sai2b: audio-controller@4400b024 {
// 		dma-names = "rx";
// 		st,sync = <&sai2a 2>;
// 		clocks = <&rcc SAI2_K>, <&sai2a>;
// 		clock-names = "sai_ck", "MCLK";
// 		status = "okay";

// 		sai2b_port: port {
// 			sai2b_endpoint: endpoint {
// 				remote-endpoint = <&cs42l51_rx_endpoint>;
// 				format = "i2s";
// 				mclk-fs = <256>;
// 				dai-tdm-slot-num = <2>;
// 				dai-tdm-slot-width = <32>;
// 			};
// 		};
// 	};
// };

&m_can1 {
	pinctrl-names = "default", "sleep";
	pinctrl-0 = <&m_can1_pins_a>;
	pinctrl-1 = <&m_can1_sleep_pins_a>;
	status = "okay";
};

&usbphyc {
	status = "okay";
};

&usbphyc_port0 {
	phy-supply = <&v3v3>;
	st,phy-tuning = <&usb_phy_tuning>;
};

&usbh_ehci {
	phys = <&usbphyc_port0>;
	status = "okay";
};

&usbphyc_port1 {
	phy-supply = <&vdd_usb>;
	st,phy-tuning = <&usb_phy_tuning>;
};

&usbotg_hs {
	phys = <&usbphyc_port1 0>;
	phy-names = "usb2-phy";
	usb-role-switch;
	status = "okay";

	port {
		usbotg_hs_ep: endpoint {
			remote-endpoint = <&con_usbotg_hs_ep>;
		};
	};
};

&i2c1 {
	pinctrl-names = "default", "sleep";
	pinctrl-0 = <&i2c1_pins_b>;
	pinctrl-1 = <&i2c1_pins_sleep_b>;
	status = "okay";
};